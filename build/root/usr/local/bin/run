#!/bin/bash -e
#
# This file serves as the default command to the openshift-ansible image.
# Runs a playbook with inventory as specified by environment variables.
#
# SOURCE and HOME DIRECTORY: /opt/ci-artifacts/src

set -o pipefail
set -o errexit
set -o nounset

ci_banner() {
    echo "===> Running PSAP CI Test suite <==="

    echo "===> $0 $@ <=="

    git show --quiet || echo "Could not access git history ..."
    echo
    git show HEAD~ --quiet || true

    echo
    oc version
    echo
}

prechecks() {
    if [[ "${INSIDE_CI_IMAGE:-}" != "y" ]]; then
        echo "FATAL: this script shouldn't run outside of the CI image ..."
        exit 1
    fi

    if [[ -z "${KUBECONFIG}" ]]
    then
        echo "No KUBECONFIG set, cannot continue."
        exit 1
    fi
    if [[ ! -e "${KUBECONFIG}" ]]
    then
        echo "KUBECONFIG file doesn't exist, can't continue. ($KUBECONFIG)"
        exit 1
    fi
    echo "Kubeconfig found at ${KUBECONFIG}, proceeding with tests"

    if ! which oc &>/dev/null;
    then
        echo "OpenShift client not found, downloading it ..."
        mkdir -p bin
        cd bin
        wget --quiet https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/latest/openshift-client-linux.tar.gz
        tar xf openshift-client-linux.tar.gz
        rm openshift-client-linux.tar.gz
        export PATH=$PWD:$PATH
        cd ..
    fi

    if ! which helm &>/dev/null;
    then
        echo "Helm not found, downloading it ..."
        mkdir -p bin
        cd bin

        HELM_VERSION="v3.5.1"
        wget https://get.helm.sh/helm-${HELM_VERSION}-linux-amd64.tar.gz --quiet
        tar xf helm-${HELM_VERSION}-linux-amd64.tar.gz linux-amd64/helm
        mv linux-amd64/helm .
        rmdir linux-amd64
        export PATH=$PWD:$PATH
        cd ..
    fi
}

entitle() {
    echo "Testing if the cluster is already entitled ..."
    if toolbox/entitlement/test.sh --no-inspect; then
        echo "Cluster already entitled, skipping entitlement."
        return
    fi

    entitlement_deployed=0

    ENTITLEMENT_PEM=${ENTITLEMENT_PEM:-/var/run/psap-entitlement-secret/entitlement.pem}
    if [ -z "$ENTITLEMENT_PEM" ]; then
        echo "INFO: no entitlement key provided (ENTITLEMENT_PEM)"
    elif [ ! -e "$ENTITLEMENT_PEM" ]; then
        echo "INFO: entitlement key doesn't exist (ENTITLEMENT_PEM=$ENTITLEMENT_PEM)"
    else
        echo "Deploying the entitlement with PEM key from ${ENTITLEMENT_PEM}"
        toolbox/entitlement/deploy.sh --pem ${ENTITLEMENT_PEM}
        entitlement_deployed=1
    fi

    ENTITLEMENT_RESOURCES=${ENTITLEMENT_RESOURCES:-/var/run/psap-entitlement-secret/01-cluster-wide-machineconfigs.yaml}
    if [ "$entitlement_deployed" == 1 ]; then
        # entitlement already deployed
        true
    elif [ -z "$ENTITLEMENT_RESOURCES" ]; then
        echo "INFO: no entitlement resource provided (ENTITLEMENT_RESOURCES)"
    elif [ ! -e "$ENTITLEMENT_RESOURCES" ]; then
        echo "INFO: entitlement resource file doesn't exist (ENTITLEMENT_RESOURCES=$ENTITLEMENT_RESOURCES)"
     else
        echo "Deploying the entitlement from resources inside ${ENTITLEMENT_RESOURCES}"
        toolbox/entitlement/deploy.sh --machine-configs ${ENTITLEMENT_RESOURCES}
        entitlement_deployed=1
    fi


    if [ "$entitlement_deployed" == 0 ]; then
        echo "FATAL: cluster isn't entitled and not entitlement provided (ENTITLEMENT_PEM)"
        exit 1
    fi

    if ! toolbox/entitlement/wait.sh; then
        echo "FATAL: Failed to properly entitle the cluster, cannot continue."
        exit 1
    fi
}

prepare_ansible() {
    if [ -z "${ARTIFACT_DIR:-}" ]; then
        export ARTIFACT_DIR="/tmp/ci-artifacts/$(date +%Y%m%d_%H%M)"
        echo "No ARTIFACT_DIR configured, using $ARTIFACT_DIR"
    fi
    echo "Using ${ARTIFACT_DIR} for storing artifact files."

    ARTIFACT_EXTRA_LOGS_DIR="${ARTIFACT_DIR}/${1:-}/extra_logs"

    mkdir -p "${ARTIFACT_EXTRA_LOGS_DIR}"
    echo "Using ${ARTIFACT_EXTRA_LOGS_DIR} for storing extra log files."

    if [ -z "${ANSIBLE_LOG_PATH:-}" ]; then
        export ANSIBLE_LOG_PATH="${ARTIFACT_DIR}/ansible/logs"
    fi
    echo "Using ${ANSIBLE_LOG_PATH} for storing ansible logs."

    mkdir -p "$(dirname "${ANSIBLE_LOG_PATH}")"

    if [ -z "${ANSIBLE_CACHE_PLUGIN_CONNECTION:-}" ]; then
        export ANSIBLE_CACHE_PLUGIN_CONNECTION="${ARTIFACT_DIR}/ansible/facts"
    fi
    echo "Using ${ANSIBLE_CACHE_PLUGIN_CONNECTION} for storing ansible facts."

    mkdir -p "${ANSIBLE_CACHE_PLUGIN_CONNECTION}"
    # ---

    ANSIBLE_OPTS=${ANSIBLE_OPTS:--v}
    ANSIBLE_OPTS="${ANSIBLE_OPTS} \
                  ${EXTRA_ANSIBLE_OPTS:-} \
                  -e artifact_extra_logs_dir=${ARTIFACT_EXTRA_LOGS_DIR}"

    export ANSIBLE_OPTS
    export EXTRA_ANSIBLE_OPTS=

    echo "ANSIBLE_OPTS='$ANSIBLE_OPTS'"
}

##############

prechecks
ci_banner
prepare_ansible

#############

prepare_cluster_for_gpu_operator() {
    entitle

    toolbox/nfd/deploy_from_operatorhub.sh
    if ! toolbox/nfd/has_gpu_nodes.sh; then
        toolbox/scaleup_cluster.sh
        toolbox/nfd/wait_gpu_nodes.sh
    fi
}

set -x
case ${1:-} in
     "gpu-commit-ci")
        CI_IMAGE_GPU_COMMIT_CI_REPO="https://github.com/NVIDIA/gpu-operator/"
        CI_IMAGE_GPU_COMMIT_CI_REF="master"
        CI_IMAGE_GPU_COMMIT_CI_IMAGE_UID="ci-image"

        echo "Using Git repository ${CI_IMAGE_GPU_COMMIT_CI_REPO} with ref ${CI_IMAGE_GPU_COMMIT_CI_REF}"

        prepare_cluster_for_gpu_operator
        toolbox/gpu-operator/deploy_from_commit.sh "${CI_IMAGE_GPU_COMMIT_CI_REPO}" \
                                                   "${CI_IMAGE_GPU_COMMIT_CI_REF}" \
                                                   "${CI_IMAGE_GPU_COMMIT_CI_IMAGE_UID}"
        toolbox/gpu-operator/run_ci_checks.sh
        toolbox/gpu-operator/run_gpu_burn.sh

	exit 0
        ;;

    "gpu-ci")
        if [ ! -z "${2:-}" ]; then
            OPERATOR_VERSION="$2"
        else
            OPERATOR_VERSION="" # latest version
        fi
        prepare_cluster_for_gpu_operator
        toolbox/gpu-operator/deploy_from_operatorhub.sh ${OPERATOR_VERSION}
        toolbox/gpu-operator/run_ci_checks.sh
        toolbox/gpu-operator/run_gpu_burn.sh

	exit 0
        ;;

    "gpu-helm-ci")
        if [ -z "${2:-}" ]; then
            echo "FATAL: $0 $1 should receive the operator version as parameter."
            exit 1
        fi
        OPERATOR_VERSION="$2"

        prepare_cluster_for_gpu_operator
        toolbox/gpu-operator/list_version_from_helm.sh
        toolbox/gpu-operator/deploy_with_helm.sh ${OPERATOR_VERSION}
        toolbox/gpu-operator/run_ci_checks.sh
        toolbox/gpu-operator/run_gpu_burn.sh

        exit 0
        ;;

    "gpu-ci-undeploy")
        toolbox/gpu-operator/undeploy_from_operatorhub.sh
	;;

    "psap-ci")
	exec ansible-playbook ${ANSIBLE_OPTS} playbooks/openshift-psap-ci.yml
	;;

    -*)
        echo "Unknown option: ${1:-}"
        exit 1
        ;;

    *)
	echo "Nothing to do ..."
	;;
esac

exit 0
